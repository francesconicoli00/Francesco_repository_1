---
categories:  
- ""    #the front matter should be like the one found in, e.g., blog2.md. It cannot be like the normal Rmd we used
- ""
date: "2023-01-19"
description: Linear programming with Python # the title that will show up once someone gets to this page
draft: false
image: python_code.jpeg

keywords: ""
slug: linear_programming # slug is the shorthand URL address... no spaces plz
title: Optimal advertising strategy with Linear Programming (Python)
---



<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>In this workshop, we will consider the online advertising market <em>from the perspective of the advertisers</em>. In particular, you have been hired by Ben, the CEO of a legacy high-street fashion retailer in the UK. In the past few years, the retail sector has been profundly disrupted by online purchasing behaviors. In-store sales have sharply declined by 4% per year, while online sales are growing at a steady 10% per year. While Ben’s business has been relatively resilient across his network of stores, the push toward “online retailing” is irresistible. Ben has made sizeable investments to build a modern online retail platform. That said, the traffic (i.e., volume of visitors) to his e-commerce website remains limited, and the online business is still fledgling.</p>
<p>You first mission is to operate a large-scale online advertising campaign to attract more users to the platform and bring awareness around the online presence of Ben’s fashion brand. Ben wants to spend at least £1M during one month, and attract at least 200K new visitors. Ben vaguely remembers from his EMBA at LBS that <em>optimization</em> plays an important role in online advertising. However, the online advertising eco-system is complex and difficult to navigate.</p>
<div id="online-advertising-eco-system" class="section level3">
<h3>Online advertising eco-system</h3>
<p>The online advertising eco-system has two main intermediaries.</p>
<pre class="r"><code>knitr::include_graphics(&quot;/img/advertising.png&quot;,error=FALSE)</code></pre>
<p><img src="../../../../../../../../img/advertising.png" width="60%" style="display: block; margin: auto;" /></p>
<ul>
<li><em>Online ad exchanges</em>: The ad exchanges run auctions to allocate advertising space to advertisers. The ad exchange is responsible for the auction mechanism (who gets what? at which price?). The most popular online ad exchanges are Facebook and Google Ads.</li>
<li><em>Demand-side platforms (DSP)</em>: DSPs manage the client side. DSPs are responsible for the operational execution of online advertising campaigns on behalf of the advertisers. They decide whether they should participate in each eligible auction and how much to bid.</li>
</ul>
<p>Ben has hired a DSP to run a campaign on Google Adwords. However, there are are number of parameters that need to be determined. You will work towards answering the following fundamental questions:
- <em>Which keywords should you advertise to?</em>
- <em>How should you allocate your budget across keywords?</em>
- <em>What total budget should be endowed to the advertising campaign?</em></p>
<p><em>Terminology</em>: When the DSP wins an auction, the ad is displayed to the corresponding user. This is known as an <em>impression</em>. The main metric tracked by the advertiser is the <em>cost-per-click</em> (CPC). This notion corresponds to the rate of budget spent per click. The CPC for a given keyword “k” is computed as the ratio between the amount spent on the keyword k and the number of clicks on keyword k.</p>
<p><em>Historical data</em>: The DSP platform has given you access to historical data to guide your decisions. The data has been generated by advertising campaigns conducted by the DSP for similar clients (namely, competing retailers with the same positioning in the UK). Specifically, each observation is a combination of a keyword and a spend level, as well as the resulting number of clicks. Each user’s click is redirected to the e-commerce website, so that each click roughly corresponds to a new visitor.</p>
<p><em>Approach</em>: Your goal is to build a model to decide on how much should be spent on each keyword, given a prospective budget of £1M. The historical data will be utilized to construct a model that predicts the cost-per-click. Next, the “optimal” budget allocation is determined via a linear programming model.</p>
</div>
<div id="explore-the-data" class="section level2">
<h2>Explore the data</h2>
<p>The DSP platform has shared data on five potentially keywords, which have been carefully selected by Ben and his chief marketing officer. For each keyword, the DSP has identified UK retailers amongst its previous clients, having the same product positioning as Ben’s. These retailers have spent various amounts on each keyword in the past quarter, ranging from thousands to millions of pounds per month. The DSP provides the exact amount spent in each campaign, as well as the number of generated clicks. The campaign data is reported on a monthly basis.</p>
<div id="load-the-data" class="section level3">
<h3>Load the data</h3>
<ol style="list-style-type: decimal">
<li><em>Use the dataframe methods <code>.head()</code> and <code>.describe()</code> to visualize the table entries.</em></li>
</ol>
<ul>
<li><em>Aggregate the data by keyword using the <code>.groupby()</code> construct and compute different statistics (e.g., <code>.mean()</code>).</em></li>
</ul>
<pre class="python"><code>import pandas as pd
df = pd.read_csv(&quot;data_keywords.csv&quot;).set_index(&quot;ID&quot;)</code></pre>
<pre class="python"><code># Displaying first 10 rows of df &amp; visualise summary info
print(df.head(10))
print(df.describe())

# Computing summary statistics for each keyword
df.groupby(&#39;keyword&#39;).describe()</code></pre>
<pre><code>      keyword        budget  clicks
ID                                 
1   retail UK  10022.696190    3021
2   retail UK  18434.623580    5570
3   retail UK  11439.698520    3498
4   retail UK   2985.138079     995
5   retail UK  16968.520950    5121
6   retail UK  16611.733640    5027
7   retail UK   1403.177363     493
8   retail UK  16618.347420    4994
9   retail UK  14453.621840    4350
10  retail UK   2368.729643     753
              budget         clicks
count     145.000000     145.000000
mean   144266.904428   14507.482759
std    267773.129547   28965.202034
min       555.151409     305.000000
25%      8422.761074    2550.000000
50%     17608.171090    4994.000000
75%     76357.516670    9708.000000
max    998166.121400  143466.000000</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr>
<th>
</th>
<th colspan="8" halign="left">
budget
</th>
<th colspan="8" halign="left">
clicks
</th>
</tr>
<tr>
<th>
</th>
<th>
count
</th>
<th>
mean
</th>
<th>
std
</th>
<th>
min
</th>
<th>
25%
</th>
<th>
50%
</th>
<th>
75%
</th>
<th>
max
</th>
<th>
count
</th>
<th>
mean
</th>
<th>
std
</th>
<th>
min
</th>
<th>
25%
</th>
<th>
50%
</th>
<th>
75%
</th>
<th>
max
</th>
</tr>
<tr>
<th>
keyword
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
cardigan
</th>
<td>
29.0
</td>
<td>
143983.169227
</td>
<td>
248079.320732
</td>
<td>
555.151409
</td>
<td>
8422.761074
</td>
<td>
16764.78895
</td>
<td>
101870.69470
</td>
<td>
963673.06250
</td>
<td>
29.0
</td>
<td>
8550.137931
</td>
<td>
6768.498534
</td>
<td>
305.0
</td>
<td>
3717.0
</td>
<td>
6333.0
</td>
<td>
12469.0
</td>
<td>
29230.0
</td>
</tr>
<tr>
<th>
dua lipa gloves
</th>
<td>
29.0
</td>
<td>
166678.027221
</td>
<td>
260960.997207
</td>
<td>
1145.195982
</td>
<td>
8920.162744
</td>
<td>
34948.55936
</td>
<td>
93543.85565
</td>
<td>
896273.82860
</td>
<td>
29.0
</td>
<td>
4688.413793
</td>
<td>
2674.420732
</td>
<td>
505.0
</td>
<td>
2525.0
</td>
<td>
4449.0
</td>
<td>
6506.0
</td>
<td>
9708.0
</td>
</tr>
<tr>
<th>
free shipping UK
</th>
<td>
29.0
</td>
<td>
230491.680782
</td>
<td>
341431.117653
</td>
<td>
2291.103971
</td>
<td>
11306.165110
</td>
<td>
56920.50489
</td>
<td>
327874.10080
</td>
<td>
952305.03920
</td>
<td>
29.0
</td>
<td>
37462.137931
</td>
<td>
49974.595272
</td>
<td>
1738.0
</td>
<td>
4462.0
</td>
<td>
14237.0
</td>
<td>
50039.0
</td>
<td>
143466.0
</td>
</tr>
<tr>
<th>
retail UK
</th>
<td>
29.0
</td>
<td>
11756.240907
</td>
<td>
6158.478877
</td>
<td>
1403.177363
</td>
<td>
5664.703434
</td>
<td>
11646.66874
</td>
<td>
16968.52095
</td>
<td>
19959.51028
</td>
<td>
29.0
</td>
<td>
3024.862069
</td>
<td>
1629.662930
</td>
<td>
493.0
</td>
<td>
1540.0
</td>
<td>
3224.0
</td>
<td>
4108.0
</td>
<td>
5684.0
</td>
</tr>
<tr>
<th>
spotted dress
</th>
<td>
29.0
</td>
<td>
168425.404002
</td>
<td>
309009.943340
</td>
<td>
808.125025
</td>
<td>
9032.394718
</td>
<td>
38685.77373
</td>
<td>
81646.62512
</td>
<td>
998166.12140
</td>
<td>
29.0
</td>
<td>
18811.862069
</td>
<td>
30390.620305
</td>
<td>
305.0
</td>
<td>
2374.0
</td>
<td>
6977.0
</td>
<td>
14953.0
</td>
<td>
100641.0
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="define-the-cost-per-click-cpc-as-a-new-column-of-the-dataframe-df" class="section level3">
<h3>Define the cost-per-click (CPC) as a new column of the dataframe <code>df</code></h3>
<pre class="python"><code># Defining new variable cost-per-click (CPC)
df[&#39;CPC&#39;] = df[&#39;budget&#39;]/df[&#39;clicks&#39;]
df.groupby(&#39;keyword&#39;).describe()</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr>
<th>
</th>
<th colspan="8" halign="left">
budget
</th>
<th colspan="5" halign="left">
clicks
</th>
<th colspan="8" halign="left">
CPC
</th>
</tr>
<tr>
<th>
</th>
<th>
count
</th>
<th>
mean
</th>
<th>
std
</th>
<th>
min
</th>
<th>
25%
</th>
<th>
50%
</th>
<th>
75%
</th>
<th>
max
</th>
<th>
count
</th>
<th>
mean
</th>
<th>
…
</th>
<th>
75%
</th>
<th>
max
</th>
<th>
count
</th>
<th>
mean
</th>
<th>
std
</th>
<th>
min
</th>
<th>
25%
</th>
<th>
50%
</th>
<th>
75%
</th>
<th>
max
</th>
</tr>
<tr>
<th>
keyword
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
cardigan
</th>
<td>
29.0
</td>
<td>
143983.169227
</td>
<td>
248079.320732
</td>
<td>
555.151409
</td>
<td>
8422.761074
</td>
<td>
16764.78895
</td>
<td>
101870.69470
</td>
<td>
963673.06250
</td>
<td>
29.0
</td>
<td>
8550.137931
</td>
<td>
…
</td>
<td>
12469.0
</td>
<td>
29230.0
</td>
<td>
29.0
</td>
<td>
12.994695
</td>
<td>
13.656457
</td>
<td>
0.394004
</td>
<td>
1.233153
</td>
<td>
6.601738
</td>
<td>
31.135792
</td>
<td>
32.999929
</td>
</tr>
<tr>
<th>
dua lipa gloves
</th>
<td>
29.0
</td>
<td>
166678.027221
</td>
<td>
260960.997207
</td>
<td>
1145.195982
</td>
<td>
8920.162744
</td>
<td>
34948.55936
</td>
<td>
93543.85565
</td>
<td>
896273.82860
</td>
<td>
29.0
</td>
<td>
4688.413793
</td>
<td>
…
</td>
<td>
6506.0
</td>
<td>
9708.0
</td>
<td>
29.0
</td>
<td>
28.173910
</td>
<td>
36.850837
</td>
<td>
2.267715
</td>
<td>
2.467797
</td>
<td>
9.913382
</td>
<td>
36.266551
</td>
<td>
99.537300
</td>
</tr>
<tr>
<th>
free shipping UK
</th>
<td>
29.0
</td>
<td>
230491.680782
</td>
<td>
341431.117653
</td>
<td>
2291.103971
</td>
<td>
11306.165110
</td>
<td>
56920.50489
</td>
<td>
327874.10080
</td>
<td>
952305.03920
</td>
<td>
29.0
</td>
<td>
37462.137931
</td>
<td>
…
</td>
<td>
50039.0
</td>
<td>
143466.0
</td>
<td>
29.0
</td>
<td>
4.084498
</td>
<td>
1.906252
</td>
<td>
1.318242
</td>
<td>
2.309075
</td>
<td>
3.984126
</td>
<td>
6.552371
</td>
<td>
6.663920
</td>
</tr>
<tr>
<th>
retail UK
</th>
<td>
29.0
</td>
<td>
11756.240907
</td>
<td>
6158.478877
</td>
<td>
1403.177363
</td>
<td>
5664.703434
</td>
<td>
11646.66874
</td>
<td>
16968.52095
</td>
<td>
19959.51028
</td>
<td>
29.0
</td>
<td>
3024.862069
</td>
<td>
…
</td>
<td>
4108.0
</td>
<td>
5684.0
</td>
<td>
29.0
</td>
<td>
3.886945
</td>
<td>
0.791816
</td>
<td>
2.846202
</td>
<td>
3.304502
</td>
<td>
3.327663
</td>
<td>
4.774632
</td>
<td>
4.994053
</td>
</tr>
<tr>
<th>
spotted dress
</th>
<td>
29.0
</td>
<td>
168425.404002
</td>
<td>
309009.943340
</td>
<td>
808.125025
</td>
<td>
9032.394718
</td>
<td>
38685.77373
</td>
<td>
81646.62512
</td>
<td>
998166.12140
</td>
<td>
29.0
</td>
<td>
18811.862069
</td>
<td>
…
</td>
<td>
14953.0
</td>
<td>
100641.0
</td>
<td>
29.0
</td>
<td>
5.685519
</td>
<td>
2.896364
</td>
<td>
1.344268
</td>
<td>
3.804716
</td>
<td>
4.804604
</td>
<td>
9.319099
</td>
<td>
9.966786
</td>
</tr>
</tbody>
</table>
<p>
5 rows × 24 columns
</p>
</div>
<p>Below, we provide code to construct a boxplot diagram (using <code>sns.boxplot()</code>) that represents the distribution of the cost-per-click CPC for each keyword, using the package seaborn.</p>
<p><em>Note: In data science practice, it is preferable to include all the package/module dependencies at the beginning of your notebook or script. That said, for greater clarity in this workshop, we introduce them in a gradual manner.</em></p>
<pre class="python"><code>import seaborn as sns
import matplotlib.pyplot as plt
%matplotlib inline
plt.subplots(figsize=(9,6))
sns.set(style=&quot;ticks&quot;, palette=&quot;pastel&quot;)
# Draws a boxplot to show CPC per keyword
sns.boxplot(x=&quot;keyword&quot;, y=&quot;CPC&quot;,
            data=df)             
# The next command is used to adjust the display
sns.despine(offset=10, trim=True)</code></pre>
<pre class="r"><code>knitr::include_graphics(&quot;/img/output_16_0.png&quot;,error=FALSE)</code></pre>
<p><img src="../../../../../../../../img/output_16_0.png" width="60%" style="display: block; margin: auto;" /></p>
</div>
<div id="which-keyword-has-the-best-cpc-which-keyword-has-the-worst-cpc-what-hypotheses-might-explain-the-level-of-variability-of-cpc-within-the-same-keyword" class="section level3">
<h3>Which keyword has the best CPC? Which keyword has the worst CPC? What hypotheses might explain the level of variability of CPC within the same keyword?</h3>
<p>The keyword with the best (lowest) CPC is “retail UK”, since it has both the lowest median and the lowest variability. The keyword with the worst CPC is “dua lipa gloves”, since, as opposed to “retail UK”, it has both the highest median and the highest variability. Presumably, the variability of CPC within the same keyword is due to the difference between the variability of the budget allocated to the keyword and the number of clicks for that keyword: most likely, the difference in size among the different UK retailers is higher than the difference in number of clicks, since even if the budget varies significantly among different retailers (according to the size of each), the number of clicks varies less than the budget. This is due to the shape of the impressions-clicks curve (logarithm-shaped): after reaching a high level of impressions, the number of clicks starts flattening out.</p>
<p>In addition, the variability of CPC can be different for different keywords, since the shape of the impressions-clicks curve can vary from keyword to keyword: most likely, the number of clicks for keywords like “dua lipa gloves” or “cardigan” tends to flatten out earlier than the one for keywords like “retail UK” and “free shipping UK” (keywords with less variable CPC).</p>
<p>A finer visualization is proposed below. <em>Execute the code in the next cells and try to interpret it. You can vary some of the arguments.</em></p>
<pre class="python"><code>df[&#39;large-budget&#39;] = df[&#39;budget&#39;]&gt;=20000
plt.subplots(figsize=(10,7))
sns.set(style=&quot;ticks&quot;, palette=&quot;pastel&quot;)
sns.boxplot(x=&quot;keyword&quot;, y=&quot;CPC&quot;,hue=&quot;large-budget&quot;, palette=[&quot;m&quot;, &quot;g&quot;],
            data=df)             
sns.despine(offset=10, trim=True)</code></pre>
<pre class="r"><code>knitr::include_graphics(&quot;/img/output_20_0.png&quot;,error=FALSE)</code></pre>
<p><img src="../../../../../../../../img/output_20_0.png" width="60%" style="display: block; margin: auto;" /></p>
<pre class="python"><code>sns.set()
keywords = df.keyword.drop_duplicates().tolist()
print(keywords)
ax = sns.regplot(x=&quot;clicks&quot;, y=&quot;budget&quot;, data=df[df[&quot;keyword&quot;] == &quot;cardigan&quot;],order = 2)</code></pre>
<pre><code>[&#39;retail UK&#39;, &#39;free shipping UK&#39;, &#39;cardigan&#39;, &#39;dua lipa gloves&#39;, &#39;spotted dress&#39;]</code></pre>
<pre class="r"><code>knitr::include_graphics(&quot;/img/output_21_1.png&quot;,error=FALSE)</code></pre>
<p><img src="../../../../../../../../img/output_21_1.png" width="60%" style="display: block; margin: auto;" /></p>
</div>
<div id="how-do-you-interpret-the-plots-above" class="section level3">
<h3>How do you interpret the plots above?</h3>
<p>As shown in the latter plot, the number of clicks and the budget allocated are positively correlated. Nevertheless, after reaching a high level of budget allocated (hence a high number of impressions), the number of clicks starts growing slower than the budget allocated, considering the keyword “cardigan”. This can be also noticed in the first visualisation (although less evidently), since the CPC corresponding to large budget allocations has higher variability and higher median for each keyword. This is due to the shape of the impressions-clicks curve, as already explained in the answer to the previous question (1.3): the variability of the budget allocated to each keyword is higher than the corresponding number of clicks for each keyword, especially for high levels of budget (&gt;= 20,000).</p>
</div>
<div id="additional-visualisation-and-interpretation" class="section level3">
<h3>Additional Visualisation and interpretation</h3>
<p>In the visualisation below, we can observe how the keywords behave in terms of clicks. This gives us an insight about how keywords can have a significantly different impressions-clicks curve. In addition, this visualisation further strengthens the argument regarding the difference in variability of the CPC for each keyword. In fact, looking at both the visualisation below and the plot showing the budget allocated to each keyword for both large-budget and small-budget allocations, we can derive the variability of the cost-per-click for each keyword. For instance, the number of clicks corresponding to the keyword “dua lipa gloves” has a low variability whereas the budget allocated to “dua lipa gloves” has a very high variability (especially for large-budget allocations). Hence, the cost-per-click for the keyword “dua lipa gloves” is going to have a very high variability.</p>
<pre class="python"><code># Visualising the number of clicks for each keyword
%matplotlib inline
plt.subplots(figsize=(9,6))
sns.set(style=&quot;ticks&quot;, palette=&quot;pastel&quot;)
# Draws a boxplot to show the number of clicks per keyword
sns.boxplot(x=&quot;keyword&quot;, y=&quot;clicks&quot;,
            data=df)
# Adjusts the display
sns.despine(offset=10, trim=True)</code></pre>
<pre class="r"><code>knitr::include_graphics(&quot;/img/output_26_0.png&quot;,error=FALSE)</code></pre>
<p><img src="../../../../../../../../img/output_26_0.png" width="60%" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>
<div id="build-a-linear-regression-model-to-predict-cpc" class="section level1">
<h1>Build a linear regression model to predict CPC</h1>
<p>As you know from Q1, the relationship between “clicks” and “budget spent” is not exactly linear. However, a linear model provides a good first-order approximation. You will begin by constructing a simple linear regression model to predict the relationship between clicks and cost <em>for each keyword</em>. To this end, you will fit a simple linear regression to predict the number of clicks (Y target variable) as a function of the budget spent (X dependent variable): the cost per click is gonna be the ratio between 1 and the coefficient estimated by the linear
regression model.</p>
<p><em>Notes:</em>
- Here, we assume that there is an intercept of zero; to obtain 0 click, you spend £0!
- Ultimately, we aim to construct a dictionary that maps each keyword to the corresponding CPC value.</p>
<div id="what-is-the-secret-metric" class="section level3">
<h3>What is the secret metric?</h3>
<pre class="python"><code># Imports numpy package and LinearRegression class from linear_model class in sklearn package
import numpy as np
from sklearn.linear_model import LinearRegression

# Defines &quot;keywords&quot; list by applying drop_duplicates method (drops the duplicates in the dataframe column) on the column
# &quot;keyword&quot; of the dataframe &quot;df&quot; and the to_list method on the result of the drop_duplicates method, to transform the output
# in a list
keywords = df.keyword.drop_duplicates().tolist()
CPC = {} # Initializes the empty dictionary &quot;CPC&quot;

# Fills up the &quot;CPC&quot; dictionary with predicted CPC for each keyword in the &quot;keywords&quot; list
for k in keywords:
    df_k = df[df[&quot;keyword&quot;]==k] # Filters the data frame for keyword &quot;k&quot; only
    # Defines the input variable &quot;X&quot; by extracting the values in the &quot;budget&quot; column, converting it into a numpy object and
    # reshaping it into an array with one column and as many rows as there are in the filtered data frame
    X = df_k.budget.values.reshape((df_k.shape[0],1))
    # The same process performed to create the input variable &quot;X&quot; is performed to create the variable &quot;y&quot;, which is the one
    # containing the output labels. In this case, the reshaping of the array is not performed.
    y = df_k.clicks.values
    # Creates an object of the class LinearRegression, specifying the &quot;fit_intercept&quot; parameter as False
    reg = LinearRegression(fit_intercept = False)
    # Applies the &quot;fit&quot; method on the &quot;reg&quot; object (fits the linear model)
    reg.fit(X, y)
    # Adds the predicted cost per click for the keyword &quot;k&quot; to the dictionary &quot;CPC&quot;
    CPC[k] = 1.0/reg.coef_[0]
    # Prints two strings displaying the cost per click for the keyword &quot;k&quot; and the R^2 for the model fitted for the keyword &quot;k&quot;
    # The &quot;Secret Metric&quot; added to the dictionary &quot;CPC&quot; is the predicted cost-per-click for each keyword
    print(&quot;\n SecretMetric of keyword &#39;&quot;+k+&quot;&#39; is: £&quot;,1/reg.coef_[0],&quot; per click&quot;)
    print(&quot;The in-sample R2 for the linear regression is:&quot;,reg.score(X,y))</code></pre>
<pre><code> SecretMetric of keyword &#39;retail UK&#39; is: £ 3.9310780928924873  per click
The in-sample R2 for the linear regression is: 0.8437186291680528

 SecretMetric of keyword &#39;free shipping UK&#39; is: £ 6.602238097902133  per click
The in-sample R2 for the linear regression is: 0.9942768652156107

 SecretMetric of keyword &#39;cardigan&#39; is: £ 31.123341466626297  per click
The in-sample R2 for the linear regression is: 0.21794901967810065

 SecretMetric of keyword &#39;dua lipa gloves&#39; is: £ 82.3019858622777  per click
The in-sample R2 for the linear regression is: -1.183433985106006

 SecretMetric of keyword &#39;spotted dress&#39; is: £ 9.869000691497781  per click
The in-sample R2 for the linear regression is: 0.9912605411318857</code></pre>
</div>
<div id="does-the-predictive-model-agree-with-the-observations-made-in-the-visualisations-section" class="section level3">
<h3>Does the predictive model agree with the observations made in the visualisations’ section?</h3>
<p>In Q1.3, after looking at the plot displaying the CPC for each keyword, we stated that the keyword with the best CPC was “retail UK” and the one with the worst CPC was “dua lipa gloves”. These observations definitely agree with the results of the linear regression: the predicted CPC for the keyword “retail UK” is £3.93 (the lowest among all the keywords), whereas the predicted CPC for “dua lipa gloves” is £82.3 (the highest among all the keywords).</p>
</div>
</div>
<div id="find-an-optimal-allocation-strategy" class="section level1">
<h1>Find an optimal allocation strategy</h1>
<p>Having computed the CPC associated with each keyword, you will now devise how the budget should be allocated across keywords to maximize the number of clicks. The total budget available is of £1M.</p>
<div id="formulating-a-linear-program" class="section level2">
<h2>Formulating a linear program</h2>
<div id="the-optimal-allocation-strategy-as-a-linear-program" class="section level3">
<h3>The optimal allocation strategy as a linear program</h3>
<p>Formulas can be written manually and uploaded into a separate .doc file. Recall that the linear program is determined via three components:
- Decision variables
- Constraints
- Objective function</p>
<p><em>Hint:</em> The goal is to inform how much to spend on each keyword.</p>
<p><em>The formula is in the additional doc submitted with the notebook file and the Executive Report</em></p>
</div>
</div>
<div id="model-creation" class="section level2">
<h2>Model creation</h2>
<pre class="python"><code># The following lines of code import the gurobi package and related functions and constants
import gurobipy as gp
from gurobipy import GRB,quicksum</code></pre>
<pre class="python"><code># Creates a new Gurobi-model object, called &quot;m&quot;
m = gp.Model(&quot;allocation&quot;)</code></pre>
<pre><code>Set parameter Username
Academic license - for non-commercial use only - expires 2023-12-31</code></pre>
</div>
<div id="decision-variables" class="section level2">
<h2>Decision variables</h2>
<pre class="python"><code># Creates a decision variable for the budget allocation to each keyword in the &quot;keywords&quot; list
allocation = m.addVars(keywords, lb = 0, name=&quot;allocation&quot;)</code></pre>
<p>The code in the above cell is adding decision variables to the model “m”. In order to do this, the method “addVars” is used on the Gurobi-model object “m”: the first argument is the list containing the keys of the dictionary which, in turn, contains the decision variables and their value; the second argument is the lower bound of the value of the decision variables (which is 0); the third argument is the name of the “gurobipy.tupledictionary” containing the decision variables. The output returned by the method is assigned to an object of type “gurobipy.tupledictionary” called “allocation”.</p>
</div>
<div id="constraint" class="section level2">
<h2>Constraint</h2>
<p>The overall budget alloction must be lower or equal to £1M, since this is the amount of budget available.</p>
<pre class="python"><code># Adding the constraint &quot;budget_constraint&quot; to the model &quot;m&quot;
budget_constraint = m.addConstr(quicksum(allocation[k] for k in keywords) &lt;= 1000000, &quot;budget_constraint&quot;)</code></pre>
</div>
<div id="objective" class="section level2">
<h2>Objective</h2>
<div id="what-is-your-objective" class="section level3">
<h3>What is your objective?</h3>
<p>The correct option is Option 3, since the product between 1.0/CPC and the budget allocation for the specific keyword gives us the total number of click for that keyword. The summation of the total clicks for each keyword is our objective function, namely the quantity we are trying to maximize.</p>
<pre class="python"><code># Option 1
#m.setObjective(allocation.sum(), GRB.MAXIMIZE)

# Option 2
#m.setObjective(quicksum(CPC[k]*allocation[k] for k in keywords), GRB.MAXIMIZE)

# Option 3: the correct option sets the model&#39;s objective function: summation of the total clicks for each keyword
m.setObjective(quicksum(1.0/CPC[k]*allocation[k] for k in keywords), GRB.MAXIMIZE)</code></pre>
<pre class="python"><code># Run the optimization and print the solution vector
def printSolution():
    if m.status == GRB.OPTIMAL:
        print(&#39;\nClicks: %g&#39; % m.objVal)
        print(&#39;\nAllocation:&#39;)
        allocationx = m.getAttr(&#39;x&#39;, allocation) 
        for k in keywords:            
                print(&#39;%s %g&#39; % (k, allocationx[k]))
    else:
        print(&#39;No solution:&#39;, m.status)
        
m.optimize()
printSolution()</code></pre>
<pre><code>Gurobi Optimizer version 10.0.0 build v10.0.0rc2 (win64)

CPU model: 12th Gen Intel(R) Core(TM) i5-1235U, instruction set [SSE2|AVX|AVX2]
Thread count: 10 physical cores, 12 logical processors, using up to 12 threads

Optimize a model with 1 rows, 5 columns and 5 nonzeros
Model fingerprint: 0x0581944e
Coefficient statistics:
  Matrix range     [1e+00, 1e+00]
  Objective range  [1e-02, 3e-01]
  Bounds range     [0e+00, 0e+00]
  RHS range        [1e+06, 1e+06]
Presolve removed 1 rows and 5 columns
Presolve time: 0.03s
Presolve: All rows and columns removed
Iteration    Objective       Primal Inf.    Dual Inf.      Time
       0    2.5438314e+05   0.000000e+00   0.000000e+00      0s

Solved in 0 iterations and 0.05 seconds (0.00 work units)
Optimal objective  2.543831428e+05

Clicks: 254383

Allocation:
retail UK 1e+06
free shipping UK 0
cardigan 0
dua lipa gloves 0
spotted dress 0</code></pre>
</div>
<div id="how-many-keywords-are-selected-in-the-bidding-strategy-why-under-which-conditions-is-this-strategy-realistic" class="section level3">
<h3>How many keywords are selected in the bidding strategy? Why? Under which conditions is this strategy realistic?</h3>
<p>The only selected keyword in the bidding strategy is the keyword “retail UK”, which is the one with the lowest predicted cost-per-click. Given the way the LP is currently framed, it is not surprising that the only selected keyword is the one with the lowest CPC: the only constraint specified in the model limits the overall budget allocation and there are no constraints influencing the way the budget is distributed among the keywords. Hence, if the only objective is to maximize the total number of clicks obtained, the budget is going to be totally allocated to the keyword with the lowest CPC.
Assuming that we don’t add any other constraint to the current LP, the following strategy is realistic whenever the capacity for the keyword “retail UK” is high enough to absorb all the impressions purchased by the retailer: the capacity is the number of users “interacting” with the keyword “retail UK”.</p>
</div>
<div id="what-aspect-is-not-well-captured-by-the-current-cpc-model" class="section level3">
<h3>What aspect is not well-captured by the current CPC model?</h3>
<p>In Q1.4, we could see how the number of clicks starts flattening out as the budget allocated to the keyword goes above a certain level. The current CPC model assumes that the relationship between the number of clicks and the budget allocated is linear at any level of budget allocation. In fact, the model allocates all the budget to the keyword “retail UK” assuming that the number of clicks is going to increase linearly as the budget allocated increases. Although, as shown by the data, this is not what happens in the real case. Hence, the aspect that is not well-captured by the current CPC model is the logarithmic shape of the impressions-clicks curve.</p>
</div>
</div>
</div>
<div id="diversification" class="section level1">
<h1>Diversification</h1>
<p>Ben (who is not well-versed in optimization) is puzzled by the output of the model.</p>
<p><em>Should we put all our eggs in one basket? I suggest to impose a constraint that at most £300,000 are invested on each single keyword. Hopefully, this will diversify our allocation strategy.</em></p>
<pre class="python"><code># Adds diversification constraints, limiting the amount of budget spent on each keyword
diversification_constrs = m.addConstrs((allocation[k] &lt;=300000  for k in keywords), &quot;diversification_constrs&quot;)</code></pre>
<p><em>Execute the next cell to re-run the model and print the optimal allocation of budget.</em></p>
<pre class="python"><code>m.optimize() # Re-optimizes the model
printSolution() # Prints solution after re-optimization</code></pre>
<pre><code>Gurobi Optimizer version 10.0.0 build v10.0.0rc2 (win64)

CPU model: 12th Gen Intel(R) Core(TM) i5-1235U, instruction set [SSE2|AVX|AVX2]
Thread count: 10 physical cores, 12 logical processors, using up to 12 threads

Optimize a model with 6 rows, 5 columns and 10 nonzeros
Coefficient statistics:
  Matrix range     [1e+00, 1e+00]
  Objective range  [1e-02, 3e-01]
  Bounds range     [0e+00, 0e+00]
  RHS range        [3e+05, 1e+06]
Iteration    Objective       Primal Inf.    Dual Inf.      Time
       0    2.5438314e+05   7.000000e+05   0.000000e+00      0s
       3    1.5536532e+05   0.000000e+00   0.000000e+00      0s

Solved in 3 iterations and 0.01 seconds (0.00 work units)
Optimal objective  1.553653168e+05

Clicks: 155365

Allocation:
retail UK 300000
free shipping UK 300000
cardigan 100000
dua lipa gloves 0
spotted dress 300000</code></pre>
<div id="how-do-you-explain-the-optimal-amount-spent-on-each-keyword-why-is-the-keyword-dua-lipa-gloves-left-out" class="section level3">
<h3>How do you explain the optimal amount spent on each keyword? Why is the keyword “dua lipa gloves” left out?</h3>
<p>In this case, we added another constraint that limits the amount of budget that can be spent on each keyword. After re-optimizing the model, we can see how the keywords “retail UK”, “free shipping UK” and “spotted dress” all received a budget allocation of £300,000 (the maximum that can be allocated to each keyword); the keyword “cardigan” received the remaining amount of the budget (£100,000) and the keyword “dua lipa gloves” was not picked. In fact, we can notice how the keywords “retail UK”, “free shipping UK” and “spotted dress” are the words with the lowest CPC. We can see how the model allocates as much budget to these words as is allowed by the constraints. More specifically, the model is going to allocate the budget to the keywords in an ordered fashion: the keyword with the lowest CPC is picked and receives as much budget as allowed by the constraints of the LP. Afterwards, the keyword with the second lowest CPC is picked and receives as much budget as allowed and so on. This only leaves £100,000 for the keyword with the fourth lowest (second highest) CPC and £0 for the keyword with the highest CPC.</p>
</div>
<div id="how-many-more-clicks-can-be-generated-by-slightly-increasing-the-300k-diversification-goal-in-the-new-constraints" class="section level3">
<h3>How many more clicks can be generated by slightly increasing the 300K diversification goal in the new constraints?</h3>
<p><em>Hint:</em> What notion allows you to conduct a sensitivity analysis? Use the dictionary <code>diversification_constrs</code> declared in Q4.1.</p>
<p>The notion that allows us to conduct a sensitivity analysis on the LP is that of “shadow price”. The shadow price of a constraint is by how much the optimal value of the LP varies if we varies the Right-Hand-Side value of the constraint. Let’s perform this analysis on the constraint “diversification_constrs”.</p>
<pre class="python"><code># Prints shadow price of &quot;diversification_constrs&quot; for each keyword
for k in keywords:
    print(&#39;The shadow price for the keyword &quot;&#39;+ k +&#39;&quot; is: &#39;+ str(diversification_constrs[k].Pi))</code></pre>
<pre><code>The shadow price for the keyword &quot;retail UK&quot; is: 0.2222529166807552
The shadow price for the keyword &quot;free shipping UK&quot; is: 0.1193335631200969
The shadow price for the keyword &quot;cardigan&quot; is: 0.0
The shadow price for the keyword &quot;dua lipa gloves&quot; is: 0.0
The shadow price for the keyword &quot;spotted dress&quot; is: 0.06919715553912442</code></pre>
</div>
</div>
<div id="the-economics-of-advertising" class="section level1">
<h1>The economics of advertising</h1>
<p>Ben would like to get further insights about the financial outcomes of this marketing campaign. Specifically, he seeks to understand how the campaign budget might affect the revenue generated by the online website. He expects that each click is monetized at £4 on average (£4 per click), in view of the subsequent purchases made by the new visitors.</p>
<p><em>With more traffic, we can achieve more revenue and cover our advertising investments. It would be ideal if this marketing campaign breaks even!</em></p>
<p>The key financial metric of this marketing campaign is the Net Revenue: the difference between the Total Revenue
generated by the campaign and the Total Budget allocated to the campaign.</p>
<div id="plot-the-optimal-net-revenue-as-a-function-of-the-total-budget." class="section level3">
<h3>Plot the optimal net revenue as a function of the total budget.</h3>
<p><em>Hint:</em> Re-use model <code>m</code> constructed in questions Q3 and Q4 to achieve the following:
1. To modify the budget constraint, you can use the construct <code>budget_constraint.setAttr("rhs",NEWBUDGET)</code> for each modified budget value <code>NEWBUDGET</code>.
- Vary the budget constraint from 0 to £1M with increments of £100K, and compute the corresponding net revenue based on the above formula.
- Construct a scatter plot of “net revenue” as a function of “budget”.</p>
<pre class="python"><code># Declares an array that contains the budgets from 0 to £1M by increments of £100K
budgets = np.arange(0,1100000,100000)

# Declares an array that contains the corresponding optimal net revenue
net_revenue = np.zeros(11)

# Runs the optimization for each budget value using a &quot;for&quot; loop
for i in range(11):
    # Since we will run the optimization for multiple budget value, we deactivate the logs of the solver
    m.setParam(&#39;OutputFlag&#39;, 0)

    # Modifies the budget constraint
    budget_constraint.setAttr(&quot;rhs&quot;, budgets[i])
    
    # Re-optimizes the model
    m.optimize()
    
    # Computes the optimal net revenue and stores it in the array `net_revenue`
    net_revenue[i] = m.objVal*4 - budgets[i]
</code></pre>
<pre class="python"><code># Plots the net revenue as a function of the budget 
ax = sns.scatterplot(x=budgets,y=net_revenue)
ax.set_xlabel(&quot;Budget&quot;)
ax.set_ylabel(&quot;Net revenue&quot;)
ax.ticklabel_format(style=&#39;plain&#39;, axis=&#39;x&#39;) # Fixes the format of the tick labels on the x-axis</code></pre>
<pre class="r"><code>knitr::include_graphics(&quot;/img/output_71_0.png&quot;,error=FALSE)</code></pre>
<p><img src="../../../../../../../../img/output_71_0.png" width="60%" style="display: block; margin: auto;" /></p>
</div>
<div id="is-there-any-concern-you-would-like-to-share-with-ben" class="section level3">
<h3>Is there any concern you would like to share with Ben?</h3>
<p>As shown in the scatter plot, when the budget exceeds £400,000 the Net Revenue from the marketing campaign starts decreasing, reaching very low levels (£-350,000) at the highest budget allocation (£1M). This occurrence can be explained by referring to the logarithmic shape of the impressions-clicks curve: as we already stated multiple times in answers to previous questions, the number of clicks is not perfectly linearly correlated with the number of impressions (which is what you purchase with the budget), as for high number of impressions, the number of clicks starts flattening out. Hence, since Ben is convinced that the more traffic (impressions purchased with the budget) the better for the company, I would definitely share the trend shown in the above scatter plot and explain why this happens, besides pointing out that perhaps it is better to stop at around £300,000 if the main objective is to break-even.</p>
</div>
</div>
<div id="the-optimal-budget" class="section level1">
<h1>The Optimal Budget</h1>
<p>Ben has an idea: <em>May be we can use linear programming to find the optimal budget to maximize our net revenue!</em> Concretely, Ben’s suggestion is write down an alternative linear programming model, where “budget” is an additional decision variable and the objective is to maximize the total net revenue.</p>
<div id="formulate-the-optimal-allocation-strategy-as-a-linear-program" class="section level3">
<h3>Formulate the optimal allocation strategy as a linear program</h3>
</div>
<div id="model-creation-1" class="section level2">
<h2>Model creation</h2>
<div id="q6.2.-create-a-gurobi-new-model-m-named-allocation-budget" class="section level3">
<h3>Q6.2. Create a GUROBI new model <code>m</code>, named <code>"allocation-budget"</code></h3>
<pre class="python"><code># Creates a new Gurobi-model object &quot;m&quot;
m = gp.Model(&quot;allocation-budget&quot;)</code></pre>
</div>
</div>
<div id="decision-variables-1" class="section level2">
<h2>Decision variables</h2>
<div id="add-decision-variables-to-the-model" class="section level3">
<h3>Add decision variables to the model</h3>
<pre class="python"><code># Adds dictionary of variables &quot;allocation&quot; to the model
allocation = m.addVars(keywords, lb = 0, name=&quot;allocation&quot;)

# Adds variable &quot;budget&quot; to the model &quot;m&quot;
budget = m.addVar(lb = 0, name = &quot;budget&quot;)</code></pre>
</div>
</div>
<div id="constraints" class="section level2">
<h2>Constraints</h2>
<div id="add-a-constraint-on-the-total-budget-that-can-be-spent" class="section level3">
<h3>Add a constraint on the total budget that can be spent</h3>
<pre class="python"><code># Adds the constraint &quot;budget_constraint&quot; to model &quot;m&quot;
budget_constraint = m.addConstr(quicksum(allocation[k] for k in keywords) &lt;= budget, &quot;budget_constraint&quot;)</code></pre>
</div>
<div id="add-a-constraint-for-diversification" class="section level3">
<h3>Add a constraint for diversification</h3>
<pre class="python"><code># Adds a diversification constraint for each keyword to model &quot;m&quot;
diversification_constrs = m.addConstrs((allocation[k] &lt;=300000  for k in keywords), &quot;diversification_constrs&quot;)</code></pre>
</div>
</div>
<div id="objective-1" class="section level2">
<h2>Objective</h2>
<div id="specify-the-linear-objective" class="section level3">
<h3>Specify the linear objective</h3>
<p>The objective function of this model (Net Revenue from the marketing campaign) can be specified as the difference
between four times the summation of the number of clicks obtained per each keyword and the total budget allocated
to the marketing campaign.</p>
<pre class="python"><code># Sets the model&#39;s objective
m.setObjective((quicksum(4.0/CPC[k]*allocation[k] for k in keywords) - budget), GRB.MAXIMIZE)</code></pre>
</div>
</div>
<div id="solve" class="section level2">
<h2>Solve</h2>
<pre class="python"><code># Run the optimization and print the solution vector
def printSolution():
    if m.status == GRB.OPTIMAL:
        print(&#39;\nNet Revenue: %g&#39; % m.objVal)
        print(&#39;\nAllocation:&#39;)
        allocationx = m.getAttr(&#39;x&#39;, allocation)
        for k in keywords:            
                print(&#39;%s %g&#39; % (k, allocationx[k]))
        print(&quot;\nBudget: &quot;,budget.x)
    else:
        print(&#39;No solution:&#39;, m.status)
m.optimize()
printSolution()</code></pre>
<pre><code>Gurobi Optimizer version 10.0.0 build v10.0.0rc2 (win64)

CPU model: 12th Gen Intel(R) Core(TM) i5-1235U, instruction set [SSE2|AVX|AVX2]
Thread count: 10 physical cores, 12 logical processors, using up to 12 threads

Optimize a model with 6 rows, 6 columns and 11 nonzeros
Model fingerprint: 0x07ef97b7
Coefficient statistics:
  Matrix range     [1e+00, 1e+00]
  Objective range  [5e-02, 1e+00]
  Bounds range     [0e+00, 0e+00]
  RHS range        [3e+05, 3e+05]
Presolve removed 6 rows and 6 columns
Presolve time: 0.00s
Presolve: All rows and columns removed
Iteration    Objective       Primal Inf.    Dual Inf.      Time
       0    5.2597714e+03   0.000000e+00   0.000000e+00      0s

Solved in 0 iterations and 0.03 seconds (0.00 work units)
Optimal objective  5.259771402e+03

Net Revenue: 5259.77

Allocation:
retail UK 300000
free shipping UK 0
cardigan 0
dua lipa gloves 0
spotted dress 0

Budget:  300000.0</code></pre>
<div id="what-is-the-optimal-budget-level-which-keywords-are-then-selected-how-do-you-interpret-this-result" class="section level3">
<h3>What is the optimal budget level? Which keyword(s) are then selected? How do you interpret this result?</h3>
<p>The optimal budget level is £300,000. The only selected keyword by the model is “retail UK”, the one with the lowest CPC (£3.93). According to the way the LP is framed, the objective is to maximize the Net Revenue from the marketing campaign without exceeding the budget and by allocating £300,000 to each keyword at most. If we delve deeper in the analysis, we notice that the keyword “retail UK” is the only one with a CPC lower than £4 (the revenue-per-click). Hence, it is the only word it is worth to invest in in order to maximize the Net Revenue. In fact, investing in any other keyword would only reduce the Net Revenue since the CPC of each other keyword is higher than £4. For this reason, the model allocates the maximum amount of budget possible to the keyword “retail UK” (£300,000) and does not pick all the remaining keywords.</p>
</div>
<div id="in-fact-ben-wants-to-spend-the-largest-possible-budget-for-which-the-firm-breaks-even.-modify-the-lp-accordingly.-is-the-optimal-budget-larger-or-smaller-than-in-the-previous-formulation" class="section level3">
<h3>In fact, Ben wants to spend the largest possible budget for which the firm breaks even. Modify the LP accordingly. Is the optimal budget larger or smaller than in the previous formulation?</h3>
<pre class="python"><code># Adds &quot;breakEven&quot; constraint to model &quot;m&quot;
breakEven = m.addConstr((quicksum(4.0/CPC[k]*allocation[k] for k in keywords) - budget == 0), &quot;breakEven&quot;)

# Sets new objective for model &quot;m&quot;
m.setObjective(budget, GRB.MAXIMIZE)

# Run the optimization and print the solution vector
def printSolution():
    if m.status == GRB.OPTIMAL:
        print(&#39;\nBudget: %g&#39; % m.objVal)
        print(&#39;\nAllocation:&#39;)
        allocationx = m.getAttr(&#39;x&#39;, allocation)
        for k in keywords:            
                print(&#39;%s %g&#39; % (k, allocationx[k]))
    else:
        print(&#39;No solution:&#39;, m.status)
                    
m.optimize()
printSolution()</code></pre>
<pre><code>Gurobi Optimizer version 10.0.0 build v10.0.0rc2 (win64)

CPU model: 12th Gen Intel(R) Core(TM) i5-1235U, instruction set [SSE2|AVX|AVX2]
Thread count: 10 physical cores, 12 logical processors, using up to 12 threads

Optimize a model with 7 rows, 6 columns and 17 nonzeros
Coefficient statistics:
  Matrix range     [5e-02, 1e+00]
  Objective range  [1e+00, 1e+00]
  Bounds range     [0e+00, 0e+00]
  RHS range        [3e+05, 3e+05]
Iteration    Objective       Primal Inf.    Dual Inf.      Time
       0    5.0000000e+30   7.811713e+30   5.000000e+00      0s
       2    3.1334477e+05   0.000000e+00   0.000000e+00      0s

Solved in 2 iterations and 0.01 seconds (0.00 work units)
Optimal objective  3.133447678e+05

Budget: 313345

Allocation:
retail UK 300000
free shipping UK 13344.8
cardigan 0
dua lipa gloves 0
spotted dress 0</code></pre>
<p>The optimal budget obtained in this case is higher than the one obtained previously. This happens beacuse the model, after reaching the maximum allocation for the keyword “retail UK”, starts allocating the budget to the keyword with the second lowest CPC (“free shipping UK”). As we already know, the CPC of the keyword “free shipping UK” is higher than the Revenue-per-click, meaning that if the model allocates money to this keyword, the Net Revenue will start decreasing. Hence, the model stops allocating money to this keyword as soon as the Net Revenue reaches 0. For this reason, the budget is higher than the one obtained previously, since, in this case, it is equal to the budget obtained previously plus the budget that must be allocated to the keyword “free shipping UK” in order to reduce the Net Revenue to 0.</p>
</div>
</div>
</div>
<div id="practical-considerations" class="section level1">
<h1>Practical considerations</h1>
<p>We now adopt a critical view on our linear programming model, and discuss approaches to make it more realistic.</p>
<div id="what-other-aspects-of-the-marketing-campaign-it-would-be-useful-to-predict-why" class="section level3">
<h3>What other aspects of the marketing campaign it would be useful to predict? Why?</h3>
<p>The first aspect of the marketing campaign it would be useful to predict is the Revenue-per-click generated for each keyword. In fact, when answering questions 5 &amp; 6, we are based on an assumption made by Ben but we don’t really know what is the evidence supporting this assumption. It would be much better to predict the Revenue-per-click for each keyword, assuming that we have the data to train our model and produce an accurate prediction. This would ultimately lead to a more precise prediction of the Net Revenue from the marketing campaign and, consequently, to a more effective budget allocation.</p>
<p>In addition, it would be extremely useful to predict what is the capacity for each keyword (the number of users interacting with each keyword). Since, after multiple plots and analyses, we understood that the relationship between the number of impressions and the number of clicks is not exactly linear, it is up to the company to choose the proper threshold where to stop allocating money to each single keyword. Assuming that we have the data to approximately calculate the point where the number of clicks starts flattening out, we could incorporate the threshold (which could be different for each keyword) in our model. One possible way to do so is to predict the CPC needed to reach different number of clicks for each keyword. Afterwards, we could observe approximately at what point of the budget allocation there is the least increase in number of clicks and pick that value as the threshold.</p>
</div>
<div id="in-the-first-part-of-the-workshop-the-goal-was-to-maximize-the-number-of-clicks.-in-practice-what-objective-retailers-care-about-when-acquiring-new-users" class="section level3">
<h3>In the first part of the workshop, the goal was to maximize the number of clicks. In practice, what objective retailers care about when acquiring new users?</h3>
<p>The number of clicks is only a rough approximation of the real objective of retailers. Obviously, the element retailers really care about is the revenue that can be earned from each click. This is probably the reason why Ben decides to shift the analysis to the Net Revenue from the marketing campaign rather than just the total number of clicks. In fact, concepts like Conversion Rate or Customer Lifetime Value (CLV) become extremely significant when building models or making predictions. Hence, maximizing the number of clicks is generally not enough: it is important to maximize the number of users that make purchases, especially those users who make expensive purchases.</p>
</div>
<div id="in-practice-you-might-have-very-limited-data-on-each-keyword-and-the-popular-keywords-are-constantly-changing-due-to-various-trends-e.g.-new-dua-lipa-gloves.-why-is-this-an-issue-how-would-you-modify-your-strategy-to-cope-with-this-issue" class="section level3">
<h3>In practice, you might have very limited data on each keyword, and the popular keywords are constantly changing due to various trends (e.g., new Dua Lipa gloves). Why is this an issue? How would you modify your strategy to cope with this issue?</h3>
<p>Sparse data or trends changing the users’ interactivity are both elements that harm the accuracy of the prediction of the CPC, which is one of the main indices on which we based our Linear Programs so far. In case of sparse data, we could substitute our linear regression model with models that can handle sparse data better (like KNN) so that the accuracy of the prediction is not compromised. In addition, we could add new predictors (variables used as an input to predict the CPC) so that it becomes possible to use other ML algorithms (like XGBoost or Random Forests).
The presence of trends for specific keywords, though, could not be solvable by changing predictive algorithm. For this reason, we could try to predict the change in CPC depending on how the interactivity varies (it could be possible to use time series analysis and predict the future movement of the CPC based on past interactions) but this would be extremely complicated. Instead, we could reframe the Linear Program, trying to use indices less sensitive to the trends’ variability. For instance, we could base our linear program on the Customer Lifetime Value or the Conversion Rate (indices that might be more robust to periodical trends).</p>
</div>
<div id="retailers-often-post-ads-on-several-online-exchanges-simultaneously.-the-same-user-might-see-your-ad-several-times-across-platforms-and-keywords-before-she-decides-to-click.-is-this-an-issue-why" class="section level3">
<h3>Retailers often post ads on several online exchanges, simultaneously. The same user might see your ad several times (across platforms and keywords) before s/he decides to click. Is this an issue? Why?</h3>
<p>The overlap across platforms and keywords represents an issue for the analysis we performed. This is because a user might decide to click on an impression after having typed another keyword and seen the same impression multiple times. This would mean that the difference in CPC among the keywords is only caused by the variability in the customer behaviour. Hence, there would be no difference in terms of “efficiency” between the keywords; the only difference would be caused by the moment when the customer decides to click on the impression. The same reasoning applies to the overlap between different platforms: the customer might decide to click on the impression only because he saw the impression on other platforms, not because the ad on that specific platform is more “effective” than the ones on other platforms.</p>
</div>
</div>
<div id="piecewise-linear-cpc-models" class="section level1">
<h1>Piecewise Linear CPC Models</h1>
<p>You find the current linear CPC model quite unrealistic. According to this model, the cost grows linearly in the desired number of clicks. Your intuition is that the CPC cost is a non-linear function of the budget. <em>Getting 1M clicks is relatively more expensive than getting a thousand clicks!</em></p>
<p>The following heatmap plots the CPC per keyword and per budget level:</p>
<pre class="r"><code>knitr::include_graphics(&quot;/img/CPC.png&quot;,error=FALSE)</code></pre>
<p><img src="../../../../../../../../img/CPC.png" width="60%" style="display: block; margin: auto;" /></p>
<div id="does-the-heatmap-support-your-intuition-what-phenomenon-explains-the-variation-of-the-cpc" class="section level3">
<h3>Does the heatmap support your intuition? What phenomenon explains the variation of the CPC?</h3>
<p>As already stated in the answers to previous questions, if we express the number of clicks as a function of the total budget allocated to that specific keyword, the shape of the function is going to be logarithmic. Hence, the heatmap definitely supports our intuition. This happens because when users are presented with the same impression many times, they start getting tired of this repetitiveness and start interacting less with the impression itself.</p>
<p>Consequently, we will approximate the CPC model using a <strong>piecewise linear function</strong> instead of a <strong>linear model</strong>. The parameters of the piecewise model were estimated on data and described below.</p>
<pre class="python"><code># The following dictionary contains the linear slopes in each budget segment, for each keyword

pieces_list = [&#39;piece A&#39;,&#39;piece B&#39;]
PiecewiseCPC = {(&#39;retail UK&#39;, &#39;piece A&#39;): [4.1, 0, 20000],
                 (&#39;retail UK&#39;, &#39;piece B&#39;): [1e+100, 20000, 1000000],
                 (&#39;free shipping UK&#39;, &#39;piece A&#39;): [3.0, 0, 20000],
                 (&#39;free shipping UK&#39;, &#39;piece B&#39;): [6.9, 20000, 1000000],
                 (&#39;cardigan&#39;, &#39;piece A&#39;): [1.5, 0, 20000],
                 (&#39;cardigan&#39;, &#39;piece B&#39;): [41.1, 20000, 1000000],
                 (&#39;dua lipa gloves&#39;, &#39;piece A&#39;): [2.5, 0, 20000],
                 (&#39;dua lipa gloves&#39;, &#39;piece B&#39;): [233.6, 20000, 1000000],
                 (&#39;spotted dress&#39;, &#39;piece A&#39;): [4.7, 0, 20000],
                 (&#39;spotted dress&#39;, &#39;piece B&#39;): [10.4, 20000, 1000000]}</code></pre>
<pre class="python"><code>keywords</code></pre>
<pre><code>[&#39;retail UK&#39;,
 &#39;free shipping UK&#39;,
 &#39;cardigan&#39;,
 &#39;dua lipa gloves&#39;,
 &#39;spotted dress&#39;]</code></pre>
<p><em>How do you interpret the PiecewiseCPC dictionary?</em>
- The CPC model has two linear pieces.
- For example for “cardigan”, the cost increases initially by £1.5 per click, between 0 and 20,000 clicks. Next, the cost increases by £41.1 per click, between 20,000 and 1,000,000 clicks.</p>
<p><em>Why is the slope very large for the keyword “retail UK” on piece B</em>?
- There is no historical data point to inform the slope above 20,000 clicks for the keyword “retail UK”
- Instead of extrapolating what the slope would be, we put a large conservative value, so that our model won’t pick a budget larger than that corresponding to 20,000 clicks.
- <em>When you don’t know, you should not guess!</em></p>
</div>
<div id="develop-a-linear-program-that-optimizes-the-allocation-of-1m-under-piecewise-linear-cpc-models." class="section level3">
<h3>Develop a linear program that optimizes the allocation of £1M under piecewise linear CPC models.</h3>
<p>Create one extra decision variable for each keyword and piece of the CPC function. For example, the “retail UK” allocation variable can be decomposed as x_retailUK = y_retailUK,A + y_retailUK,B with two new decision variables y_retailUK,A,y_retailUK,B, where y_retailUK,A is upper bounded by 20,000.</p>
<pre class="python"><code># Building the new linear program
m = gp.Model(&quot;allocation_piecewise&quot;)

# Adds variables &quot;allocation&quot; to the model
allocation = m.addVars(keywords, lb = 0, name=&quot;allocation&quot;)

# Adds &quot;interval_pieces&quot; variables to the model by passing the dictionary &quot;upper_interval&quot; as the parameter for upper bound
upper_interval = {(k,s): (PiecewiseCPC[k,s][2] - PiecewiseCPC[k,s][1]) for k in keywords for s in pieces_list}
interval_pieces = m.addVars(keywords,pieces_list, lb = 0, ub = upper_interval, name=&quot;auxiliary&quot;)

# Adding the budget_constraint and the paired_csrts to the model
budget_constraint = m.addConstr(quicksum(allocation[k] for k in keywords)&lt;=1000000 ,&quot;budget_constraint&quot;)
paired_cstrs = m.addConstrs((quicksum(interval_pieces[k,s] for s in pieces_list) == allocation[k] 
                                     for k in keywords), &quot;paired_cstrs&quot;)

# Setting the same objective as the one in Q3 for comparison purposes
m.setObjective(quicksum(1.0/PiecewiseCPC[k,s][0]*interval_pieces[k,s] for k in keywords for s in pieces_list), GRB.MAXIMIZE)

# Optimizing the model and printing the solution
def printSolution():
    if m.status == GRB.OPTIMAL:
        print(&#39;\nClicks: %g&#39; % m.objVal)
        print(&#39;\nAllocation:&#39;)
        allocationx = m.getAttr(&#39;x&#39;, allocation) 
        for k in keywords:            
                print(&#39;%s %g&#39; % (k, allocationx[k]))
    else:
        print(&#39;No solution:&#39;, m.status)

m.optimize()
printSolution()</code></pre>
<pre><code>Gurobi Optimizer version 10.0.0 build v10.0.0rc2 (win64)

CPU model: 12th Gen Intel(R) Core(TM) i5-1235U, instruction set [SSE2|AVX|AVX2]
Thread count: 10 physical cores, 12 logical processors, using up to 12 threads

Optimize a model with 6 rows, 15 columns and 20 nonzeros
Model fingerprint: 0x989488c9
Coefficient statistics:
  Matrix range     [1e+00, 1e+00]
  Objective range  [1e-100, 7e-01]
  Bounds range     [2e+04, 1e+06]
  RHS range        [1e+06, 1e+06]
Presolve removed 5 rows and 6 columns
Presolve time: 0.02s
Presolved: 1 rows, 9 columns, 9 nonzeros

Iteration    Objective       Primal Inf.    Dual Inf.      Time
       0    6.6666667e+05   1.225000e+05   0.000000e+00      0s
       1    1.6756815e+05   0.000000e+00   0.000000e+00      0s

Solved in 1 iterations and 0.02 seconds (0.00 work units)
Optimal objective  1.675681505e+05

Clicks: 167568

Allocation:
retail UK 20000
free shipping UK 920000
cardigan 20000
dua lipa gloves 20000
spotted dress 20000</code></pre>
</div>
<div id="which-keywords-are-selected-in-the-optimal-allocation-strategy-compare-to-the-result-obtained-when-the-model-was-fitted-for-the-first-time." class="section level3">
<h3>Which keywords are selected in the optimal allocation strategy? Compare to the result obtained when the model was fitted for the first time.</h3>
<p>After building a piecewise Linear Program, we obtained a different optimal allocation strategy. In the new result, we can see how all the variables have been picked. In fact, now that the slope of the function changes dramatically for each keyword, the model is forced to explore other choices and diversify the budget allocation.</p>
</div>
<div id="about-the-piecewise-linear-model" class="section level3">
<h3>About the piecewise linear model…</h3>
<p>How would you estimate the piecewise linear CPC model from historical data? The code is provided below.
1. Slice the data set into three budget segments: [0,20000], [20000,1000000],
- Within each budget segment, fit a linear regression model to obtain the “slope” of the CPC function
- In this case, you need to use an intercept in the model.</p>
<pre class="python"><code>keywords = df.keyword.drop_duplicates().tolist()
pCPC = {}
pieces = {&#39;piece A&#39;: [0,20000], &#39;piece B&#39;: [20000,1000000]}

for k in keywords:
    for p in pieces.keys():
        df_k = df[(df[&quot;keyword&quot;]==k) &amp;(pieces[p][0]&lt;=df[&#39;budget&#39;])&amp;(pieces[p][1]&gt;=df[&#39;budget&#39;])]
        if df_k.shape[0]&gt; 0:
            X = df_k.budget.values.reshape((df_k.shape[0],1))
            y = df_k.clicks.values 
            reg = LinearRegression(fit_intercept = True).fit(X, y)
            pCPC[k,p] = [1.0/reg.coef_[0]] + pieces[p]
            print(&quot;\n CPC of keyword &quot;+k+ &quot; and &quot;+p+&quot; is: £&quot;,1/reg.coef_[0],&quot; per click&quot;)
            print(&quot;The R2 for the linear regression is:&quot;,reg.score(X,y))            
        else:
            pCPC[k,p] = [GRB.INFINITY] + pieces[p]            </code></pre>
<pre><code> CPC of keyword retail UK and piece A is: £ 4.108797336465324  per click
The R2 for the linear regression is: 0.8459055955015281

 CPC of keyword free shipping UK and piece A is: £ 3.040688826141064  per click
The R2 for the linear regression is: 0.8084685625178041

 CPC of keyword free shipping UK and piece B is: £ 6.943809878345913  per click
The R2 for the linear regression is: 0.9985379109774118

 CPC of keyword cardigan and piece A is: £ 1.5581151104525688  per click
The R2 for the linear regression is: 0.4575230748616187

 CPC of keyword cardigan and piece B is: £ 41.15743647805941  per click
The R2 for the linear regression is: 0.8732355509244926

 CPC of keyword dua lipa gloves and piece A is: £ 2.495861169515519  per click
The R2 for the linear regression is: 0.9998388558619081

 CPC of keyword dua lipa gloves and piece B is: £ 233.57280649945102  per click
The R2 for the linear regression is: 0.21762698141762626

 CPC of keyword spotted dress and piece A is: £ 4.668905691297152  per click
The R2 for the linear regression is: 0.9544652133762289

 CPC of keyword spotted dress and piece B is: £ 10.395381050040964  per click
The R2 for the linear regression is: 0.9963554606572295</code></pre>
</div>
</div>
